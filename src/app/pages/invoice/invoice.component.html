<div class="container-fluid py-3">
  <div class="page-title">
    <h2 class="mb-1">Invoice Tracker</h2>
    <p class="text-muted mb-4">
      Track COGS, Fixed Expenses, and Other Invoices separately.
    </p>
  </div>

  <div class="filters-bar">
    <div class="filter-item">
      <label class="filter-label">
        <i class="pi pi-map-marker"></i> Locations
      </label>

      <p-multiSelect
        [options]="locations"
        [(ngModel)]="selectedLocation"
        optionLabel="location_name"
        placeholder="Select locations"
        [maxSelectedLabels]="3"
        display="chip"
        styleClass="w-100"
        (onChange)="onLocationsChange()"
      ></p-multiSelect>
    </div>

    <div class="filter-item">
      <label class="filter-label">
        <i class="pi pi-calendar"></i> Date Range
      </label>

      <p-datepicker
        [(ngModel)]="dateRange"
        selectionMode="range"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        [readonlyInput]="true"
        placeholder="Select date range"
        styleClass="w-100"
        (ngModelChange)="onLocationsChangeDate($event)"
      ></p-datepicker>
    </div>
  </div>

  <div class="summary-row">
    <p-card class="sum-card sum-cogs" (click)="activeTab = 1">
      <div class="sum-inner">
        <div class="sum-top">
          <i class="pi pi-wallet"></i>
          <span class="sum-title">COGS</span>
        </div>

        <div class="sum-value">{{ totalCat1 | number : "1.2-2" }}</div>
        <div class="sum-sub">{{ cantidadCat1 }} entries</div>
      </div>
    </p-card>

    <p-card class="sum-card sum-fixed" (click)="activeTab = 2">
      <div class="sum-inner">
        <div class="sum-top">
          <i class="pi pi-briefcase"></i>
          <span class="sum-title">Fixed Expense</span>
        </div>

        <div class="sum-value">{{ totalCat2 | number : "1.2-2" }}</div>
        <div class="sum-sub">{{ cantidadCat2 }} entries</div>
      </div>
    </p-card>

    <p-card class="sum-card sum-other" (click)="activeTab = 3">
      <div class="sum-inner">
        <div class="sum-top">
          <i class="pi pi-file"></i>
          <span class="sum-title">Other Invoice</span>
        </div>

        <div class="sum-value">{{ totalCat3 | number : "1.2-2" }}</div>
        <div class="sum-sub">{{ cantidadCat3 }} entries</div>
      </div>
    </p-card>

    <p-card class="sum-card sum-unsig" (click)="activeTab = 4">
      <div class="sum-inner">
        <div class="sum-top">
          <i class="pi pi-file"></i>
          <span class="sum-title">Unassigned Invoice</span>
        </div>

        <div class="sum-value">{{ totalCat4 | number : "1.2-2" }}</div>
        <div class="sum-sub">{{ cantidadCat4 }} entries</div>
      </div>
    </p-card>
  </div>

  <div class="invoice-actions mb-2">
    <button
      pButton
      type="button"
      label="Add COGS Invoice"
      icon="pi pi-plus"
      class="p-button-success action-btn"
      (click)="openAddInvoice(1)"
    ></button>

    <button
      pButton
      type="button"
      label="Add Fixed Expense"
      icon="pi pi-plus"
      class="p-button-info action-btn"
      (click)="openAddInvoice(2)"
    ></button>

    <button
      pButton
      type="button"
      label="Add Other Invoice"
      icon="pi pi-plus"
      class="p-button-warning action-btn"
      (click)="openAddInvoice(3)"
    ></button>
  </div>

  <div class="card">
    <p-tabView>
      <p-tabPanel header="COGS Invoice">
        <p-table
          [value]="invoice01"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 20, 50]"
          [responsiveLayout]="'scroll'"
          sortMode="multiple"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="invoice_id">
                ID <p-sortIcon field="invoice_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_date">
                Date <p-sortIcon field="invoice_date"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_vendor_description">
                Vendor
                <p-sortIcon field="invoice_vendor_description"></p-sortIcon>
              </th>
              <th pSortableColumn="category_id">
                Category <p-sortIcon field="category_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_amount" class="text-end">
                Amount <p-sortIcon field="invoice_amount"></p-sortIcon>
              </th>
              <th>Notes</th>
              <th pSortableColumn="location_id">
                Location <p-sortIcon field="location_id"></p-sortIcon>
              </th>
              <th style="width: 140px">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.invoice_id }}</td>
              <td>{{ item.invoice_date }}</td>
              <td>{{ item.invoice_vendor_description }}</td>
              <td>{{ item.category.category_code }}</td>
              <td class="text-end">{{ item.invoice_amount }}</td>
              <td>{{ item.invoice_notes || "-" }}</td>
              <td>{{ item.locations.location_name }}</td>
              <td class="text-end">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  (click)="openUpdateInvoice(item, 1)"
                ></button>

                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-danger p-button-sm"
                  (click)="openDeleteInvoice(item)"
                ></button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center py-4">No hay invoices</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tabPanel>

      <p-tabPanel header="Fixed Expense">
        <p-table
          [value]="invoice02"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 20, 50]"
          [responsiveLayout]="'scroll'"
          sortMode="multiple"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="invoice_id">
                ID <p-sortIcon field="invoice_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_date">
                Date <p-sortIcon field="invoice_date"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_vendor_description">
                Vendor
                <p-sortIcon field="invoice_vendor_description"></p-sortIcon>
              </th>
              <th pSortableColumn="category_id">
                Category <p-sortIcon field="category_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_amount" class="text-end">
                Amount <p-sortIcon field="invoice_amount"></p-sortIcon>
              </th>
              <th>Notes</th>
              <th pSortableColumn="location_id">
                Location <p-sortIcon field="location_id"></p-sortIcon>
              </th>
              <th style="width: 140px">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.invoice_id }}</td>
              <td>{{ item.invoice_date }}</td>
              <td>{{ item.invoice_vendor_description }}</td>
              <td>{{ item.category.category_code }}</td>
              <td class="text-end">{{ item.invoice_amount }}</td>
              <td>{{ item.invoice_notes || "-" }}</td>
              <td>{{ item.locations.location_name }}</td>
              <td class="text-end">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  (click)="openUpdateInvoice(item, 2)"
                ></button>

                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-danger p-button-sm"
                  (click)="openDeleteInvoice(item)"
                ></button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center py-4">No hay invoices</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tabPanel>

      <p-tabPanel header="Other Invoice">
        <p-table
          [value]="invoice03"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 20, 50]"
          [responsiveLayout]="'scroll'"
          sortMode="multiple"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="invoice_id">
                ID <p-sortIcon field="invoice_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_date">
                Date <p-sortIcon field="invoice_date"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_vendor_description">
                Vendor
                <p-sortIcon field="invoice_vendor_description"></p-sortIcon>
              </th>
              <th pSortableColumn="category_id">
                Category <p-sortIcon field="category_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_amount" class="text-end">
                Amount <p-sortIcon field="invoice_amount"></p-sortIcon>
              </th>
              <th>Notes</th>
              <th pSortableColumn="location_id">
                Location <p-sortIcon field="location_id"></p-sortIcon>
              </th>
              <th style="width: 140px">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.invoice_id }}</td>
              <td>{{ item.invoice_date }}</td>
              <td>{{ item.invoice_vendor_description }}</td>
              <td>{{ item.category.category_code }}</td>
              <td class="text-end">{{ item.invoice_amount }}</td>
              <td>{{ item.invoice_notes || "-" }}</td>
              <td>{{ item.locations.location_name }}</td>
              <td class="text-end">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  (click)="openUpdateInvoice(item, 3)"
                ></button>

                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-danger p-button-sm"
                  (click)="openDeleteInvoice(item)"
                ></button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center py-4">No hay invoices</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tabPanel>

      <p-tabPanel header="Unassigned Invoice">
        <p-table
          [value]="invoice04"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 20, 50]"
          [responsiveLayout]="'scroll'"
          sortMode="multiple"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="invoice_id">
                ID <p-sortIcon field="invoice_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_date">
                Date <p-sortIcon field="invoice_date"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_vendor_description">
                Vendor
                <p-sortIcon field="invoice_vendor_description"></p-sortIcon>
              </th>
              <th pSortableColumn="category_id">
                Category <p-sortIcon field="category_id"></p-sortIcon>
              </th>
              <th pSortableColumn="invoice_amount" class="text-end">
                Amount <p-sortIcon field="invoice_amount"></p-sortIcon>
              </th>
              <th>Notes</th>
              <th pSortableColumn="location_id">
                Location <p-sortIcon field="location_id"></p-sortIcon>
              </th>
              <th style="width: 140px">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.invoice_id }}</td>
              <td>{{ item.invoice_date }}</td>
              <td>{{ item.invoice_vendor_description }}</td>
              <td>{{ item.category.category_code }}</td>
              <td class="text-end">{{ item.invoice_amount }}</td>
              <td>{{ item.invoice_notes || "-" }}</td>
              <td>{{ item.locations.location_name }}</td>
              <td class="text-end">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm"
                  (click)="openUpdateInvoice(item, 4)"
                ></button>

                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-danger p-button-sm"
                  (click)="openDeleteInvoice(item)"
                ></button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center py-4">No hay invoices</td>
            </tr>
          </ng-template>
        </p-table>
      </p-tabPanel>
    </p-tabView>
  </div>
</div>

<app-invoice-upd-ins
  *ngIf="showAddLocationModal"
  [mode]="modalMode"
  (close)="closeModal()"
  (submit)="handleSubmit($event)"
  [invoice]="editingInvoice"
  [categoryType]="selectedCategoryType"
>
</app-invoice-upd-ins>
